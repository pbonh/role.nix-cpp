---
- name: CCLS | Install Highlighting Plugin for Neovim | lineinfile
  changed_when: false
  lineinfile:
    path: "{{ nvim_init }}"
    insertbefore: ".*Language Server Protocol Providers\\(End\\).*"
    line: "Plug 'jackguo380/vim-lsp-cxx-highlight'"

- name: CCLS | Configure ccls for Neovim | blockinfile
  changed_when: false
  blockinfile:
    path: "{{ nvim_coc_settings_file }}"
    marker: "// !-- {mark} CCLS Language Server Config --"
    insertbefore: ".*LSP Provider\\(End\\).*"
    block: |2
      "ccls": {
        "command": "{{ nix_bin }}/ccls",
        "filetypes": ["c", "cc", "cpp", "cxx", "c++", "objc", "objcpp"],
        "rootPatterns": [".ccls", "compile_commands.json", ".git/", ".vscode"],
        "initializationOptions": {
          "cache": {
            "directory": "{{ ccls_tmp_dir }}"
          },
          "highlight": { "lsRanges" : true },
          // clang args(begin)
          // clang args(end)
        }
      },

- name: CMake | Install CMake Plugin for Neovim | lineinfile
  changed_when: false
  lineinfile:
    path: "{{ nvim_init }}"
    insertbefore: ".*Language Server Protocol Providers\\(End\\).*"
    line: "Plug 'Shatur/neovim-cmake'"

- name: CMake | Configure cmake for Neovim | blockinfile
  changed_when: false
  blockinfile:
    path: "{{ nvim_init }}"
    marker: '" !-- {mark} CMake Config --'
    insertbefore: ".*Extra Plugin Settings\\(End\\).*"
    block: |2
      lua << EOF
          require('telescope').load_extension('cmake')
      EOF
      nmap <Leader>c [cmake-p]
      xmap <Leader>c [cmake-p]
      nnoremap <silent> [cmake-p]c :CMake configure<CR>
      nnoremap <silent> [cmake-p]b :CMake build<CR>
      nnoremap <silent> [cmake-p]a :CMake build_all<CR>
      nnoremap <silent> [cmake-p]r :CMake run<CR>
      nnoremap <silent> [cmake-p]d :CMake debug<CR>
      nnoremap <silent> [cmake-p]l :CMake clean<CR>
      nnoremap <silent> [cmake-p]t :Telescope select_target<CR>
      let g:cmake_asyncrun_options={'mode': 'term', 'pos': 'floaterm', 'save': 2}
      let g:cmake_target_asyncrun_options={'mode': 'term', 'pos': 'floaterm'}

- name: VSCode CppTools | Configure vscode-cpptools for Neovim | blockinfile
  changed_when: false
  blockinfile:
    path: "{{ nvim_init }}"
    marker: '" !-- {mark} VSCode CppTools Config --'
    insertbefore: ".*Extra Plugin Settings\\(End\\).*"
    block: |2
      lua << EOF
        local dap = require('dap')
        dap.adapters.cppdbg = {
          type = 'executable',
          command = '{{ vscode_cpptools_executable_path }}',
        }

        {{ vscode_cpptools_runner }}
      EOF

- name: VSCode CppTools | Configure vscode-cpptools for Neovim | blockinfile
  changed_when: false
  blockinfile:
    path: "{{ nvim_init }}"
    marker: '" !-- {mark} Neoformat C/C++ Config --'
    insertbefore: ".*Neoformat Settings\\(End\\).*"
    block: |2
      let g:neoformat_cpp_clangformat = {
        \ 'exe': '{{ nix_bin }}/clang-format',
        \ 'args': ['--style={{ clang_format_fileoption }}']
      \}
      let g:neoformat_enabled_cpp = ['clangformat']
      let g:neoformat_enabled_c = ['clangformat']

- name: Neomake | Install Neomake C++ Settings | blockinfile
  changed_when: false
  blockinfile:
    path: "{{ nvim_init }}"
    marker: '" !-- {mark} ALE C/C++ Config --'
    insertbefore: ".*ALE Settings\\(End\\).*"
    block: |2
      let g:ale_c_parse_compile_commands=1
      let g:ale_linters = {
      \   'c': ['gcc', 'g++'],
      \   'cpp': ['gcc', 'g++'],
      \}
